# 会员系统最佳实践方案

## 1. 系统概述

本文档定义了壁纸网站会员系统的完整实现方案，包括数据库设计、业务逻辑、前端交互和后端API设计。

我希望所有新建的会员相关的脚本文件，都放在 F:\XAMPP\htdocs/api/vip 目录下
小红书链接下单地址:https://www.xiaohongshu.com/goods-detail/68364be97bc1a50001452f52?xsec_token=XBF5tMSotvGdhHmhZRberyb6bCK0r2QCfHGV4XtPbuqMo%3D&xsec_source=app_share&instation_link=xhsdiscover%3A%2F%2Fgoods_detail%2F68364be97bc1a50001452f52%3Ftrade_ext%3DeyJjaGFubmVsSW5mbyI6bnVsbCwiZHNUb2tlbkluZm8iOm51bGwsInNoYXJlTGluayI6Imh0dHBzOi8vd3d3LnhpYW9ob25nc2h1LmNvbS9nb29kcy1kZXRhaWwvNjgzNjRiZTk3YmMxYTUwMDAxNDUyZjUyP2FwcHVpZD02MTJiOWRkYzAwMDAwMDAwMDEwMDkzYzciLCJsaXZlSW5mbyI6bnVsbCwic2hvcEluZm8iOm51bGwsImdvb2RzTm90ZUluZm8iOm51bGwsImNoYXRJbmZvIjpudWxsLCJzZWFyY2hJbmZvIjpudWxsLCJwcmVmZXIiOm51bGx9%26rate_limit_meta%3DitemId%253D68364be97bc1a50001452f51%26rn%3Dtrue&xhsshare=CopyLink&appuid=612b9ddc00000000010093c7&apptime=1750649922&share_id=ee83ec77afd04f14a5d8665efac6ad0a&share_channel=copy_link

### 1.1 会员类型定义

- **免费用户 (free)**：无下载限制，可使用所有基础功能
- **1元会员 (monthly)**：每30天10次特定下载，购买后30天有效期
- **永久会员 (permanent)**：无任何下载限制，永久有效

### 1.2 下载限制范围

**受限制的下载功能**（仅1元会员和永久会员可用）：
- `yulan.html` 中的"一键下载超清壁纸（手机/平板/电脑）"功能
- `yulan.html` 中的"头像下载"功能

**不受限制的下载功能**（所有用户可用）：
- 单个设备壁纸下载（手机、平板、电脑单独下载）
- 原图下载
- 封面下载
- 其他常规下载功能

## 2. 数据库设计

### 2.1 users表扩展

```sql
-- 添加会员系统字段到users表
ALTER TABLE users 
ADD COLUMN membership_type ENUM('free','monthly','permanent') DEFAULT 'free' COMMENT '会员类型',
ADD COLUMN membership_expires_at DATETIME NULL COMMENT '会员到期时间',
ADD COLUMN download_quota INT(11) DEFAULT 0 COMMENT '剩余下载次数',
ADD COLUMN quota_reset_date DATETIME NULL COMMENT '下载配额重置时间（30天后）',
ADD INDEX idx_membership_type (membership_type),
ADD INDEX idx_membership_expires (membership_expires_at),
ADD INDEX idx_quota_reset (quota_reset_date);
```

### 2.2 会员码管理表

```sql
CREATE TABLE membership_codes (
  id BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT,
  code VARCHAR(32) NOT NULL COMMENT '会员码',
  membership_type ENUM('monthly','permanent') NOT NULL COMMENT '会员类型',
  status ENUM('active','used','expired','disabled') DEFAULT 'active' COMMENT '状态',
  used_by_user_id BIGINT(20) UNSIGNED NULL COMMENT '使用用户ID',
  used_at DATETIME NULL COMMENT '使用时间',
  expires_at DATETIME NULL COMMENT '会员码过期时间',
  generated_by VARCHAR(50) DEFAULT 'system' COMMENT '生成来源',
  batch_id VARCHAR(32) NULL COMMENT '批次ID',
  notes VARCHAR(255) NULL COMMENT '备注',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY uk_code (code),
  KEY idx_status_type (status, membership_type),
  KEY idx_used_by (used_by_user_id),
  KEY idx_expires_at (expires_at),
  KEY idx_batch_id (batch_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会员码管理表';
```

### 2.3 下载记录表

```sql
CREATE TABLE user_download_logs (
  id BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id BIGINT(20) UNSIGNED NOT NULL COMMENT '用户ID',
  download_type ENUM('hd_combo','avatar','single_device','original','cover','other') NOT NULL COMMENT '下载类型',
  wallpaper_id VARCHAR(255) NULL COMMENT '壁纸标识',
  membership_type ENUM('free','monthly','permanent') NOT NULL COMMENT '下载时会员类型',
  quota_consumed TINYINT(1) DEFAULT 0 COMMENT '是否消耗配额',
  download_date DATE NOT NULL COMMENT '下载日期',
  ip_address VARCHAR(45) NULL COMMENT 'IP地址',
  user_agent TEXT NULL COMMENT '用户代理',
  download_status ENUM('success','failed','cancelled') DEFAULT 'success' COMMENT '下载状态',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  KEY idx_user_date (user_id, download_date),
  KEY idx_user_quota (user_id, quota_consumed),
  KEY idx_download_type (download_type),
  KEY idx_download_date (download_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户下载记录表';
```

## 3. 业务逻辑设计

### 3.1 会员类型管理

#### 免费用户 (free)
```php
$user_data = [
    'membership_type' => 'free',
    'download_quota' => 0,
    'membership_expires_at' => null,
    'quota_reset_date' => null
];
```

#### 1元会员 (monthly)
```php
$user_data = [
    'membership_type' => 'monthly',
    'download_quota' => 10,
    'membership_expires_at' => date('Y-m-d H:i:s', strtotime('+30 days')),
    'quota_reset_date' => date('Y-m-d H:i:s', strtotime('+30 days'))
];
```

#### 永久会员 (permanent)
```php
$user_data = [
    'membership_type' => 'permanent',
    'download_quota' => -1, // -1表示无限制
    'membership_expires_at' => null,
    'quota_reset_date' => null
];
```

### 3.2 配额重置逻辑（30天周期）

**核心原则**：1元会员的配额重置基于购买时间的30天周期，而非自然月。

```php
/**
 * 检查并重置用户配额（30天周期）
 * @param int $user_id 用户ID
 * @return bool 是否执行了重置
 */
function checkAndResetQuota($user_id) {
    $sql = "SELECT membership_type, download_quota, quota_reset_date, membership_expires_at 
            FROM users WHERE id = ?";
    $user = executeQuery($sql, [$user_id]);
    
    if (!$user || $user['membership_type'] !== 'monthly') {
        return false;
    }
    
    $now = new DateTime();
    $reset_date = new DateTime($user['quota_reset_date']);
    $expires_at = new DateTime($user['membership_expires_at']);
    
    // 检查是否需要重置配额
    if ($now >= $reset_date && $now <= $expires_at) {
        // 重置配额并设置下一个重置时间
        $next_reset = $reset_date->add(new DateInterval('P30D'));
        
        // 确保下次重置时间不超过会员到期时间
        if ($next_reset > $expires_at) {
            $next_reset = $expires_at;
        }
        
        $update_sql = "UPDATE users SET 
                       download_quota = 10, 
                       quota_reset_date = ? 
                       WHERE id = ?";
        executeQuery($update_sql, [$next_reset->format('Y-m-d H:i:s'), $user_id]);
        
        return true;
    }
    
    return false;
}
```

### 3.3 会员过期处理

```php
/**
 * 处理过期会员（定时任务）
 */
function handleExpiredMemberships() {
    $sql = "UPDATE users 
            SET membership_type = 'free', 
                download_quota = 0, 
                membership_expires_at = NULL,
                quota_reset_date = NULL
            WHERE membership_type = 'monthly' 
            AND membership_expires_at < NOW()";
    
    executeQuery($sql);
}
```

### 3.4 下载权限检查

```php
/**
 * 检查用户下载权限
 * @param int $user_id 用户ID
 * @param string $download_type 下载类型
 * @return array 权限检查结果
 */
function checkDownloadPermission($user_id, $download_type) {
    // 先检查并重置配额
    checkAndResetQuota($user_id);
    
    $sql = "SELECT membership_type, download_quota, membership_expires_at 
            FROM users WHERE id = ?";
    $user = executeQuery($sql, [$user_id]);
    
    if (!$user) {
        return ['allowed' => false, 'reason' => '用户不存在'];
    }
    
    // 不受限制的下载类型
    $unrestricted_types = ['single_device', 'original', 'cover', 'other'];
    if (in_array($download_type, $unrestricted_types)) {
        return ['allowed' => true, 'reason' => '不受限制的下载类型'];
    }
    
    // 受限制的下载类型：hd_combo, avatar
    $restricted_types = ['hd_combo', 'avatar'];
    if (!in_array($download_type, $restricted_types)) {
        return ['allowed' => true, 'reason' => '未知下载类型，默认允许'];
    }
    
    // 检查会员权限
    if ($user['membership_type'] === 'free') {
        return ['allowed' => false, 'reason' => '需要会员权限'];
    }
    
    if ($user['membership_type'] === 'permanent') {
        return ['allowed' => true, 'reason' => '永久会员无限制'];
    }
    
    if ($user['membership_type'] === 'monthly') {
        // 检查是否过期
        if ($user['membership_expires_at'] && strtotime($user['membership_expires_at']) < time()) {
            return ['allowed' => false, 'reason' => '会员已过期'];
        }
        
        // 检查配额
        if ($user['download_quota'] <= 0) {
            return ['allowed' => false, 'reason' => '下载配额已用完'];
        }
        
        return ['allowed' => true, 'reason' => '1元会员有配额'];
    }
    
    return ['allowed' => false, 'reason' => '未知会员类型'];
}
```

### 3.5 下载配额扣减

```php
/**
 * 扣减用户下载配额
 * @param int $user_id 用户ID
 * @param string $download_type 下载类型
 * @param string $wallpaper_id 壁纸ID
 * @return bool 是否成功扣减
 */
function consumeDownloadQuota($user_id, $download_type, $wallpaper_id = null) {
    // 检查权限
    $permission = checkDownloadPermission($user_id, $download_type);
    if (!$permission['allowed']) {
        return false;
    }
    
    // 记录下载日志
    $log_sql = "INSERT INTO user_download_logs 
                (user_id, download_type, wallpaper_id, membership_type, quota_consumed, download_date, ip_address) 
                VALUES (?, ?, ?, ?, ?, CURDATE(), ?)";
    
    $user = executeQuery("SELECT membership_type FROM users WHERE id = ?", [$user_id]);
    $quota_consumed = in_array($download_type, ['hd_combo', 'avatar']) && $user['membership_type'] === 'monthly' ? 1 : 0;
    
    executeQuery($log_sql, [
        $user_id, 
        $download_type, 
        $wallpaper_id, 
        $user['membership_type'], 
        $quota_consumed,
        $_SERVER['REMOTE_ADDR'] ?? ''
    ]);
    
    // 如果是1元会员且是受限制的下载，扣减配额
    if ($quota_consumed) {
        $update_sql = "UPDATE users SET download_quota = download_quota - 1 WHERE id = ? AND download_quota > 0";
        executeQuery($update_sql, [$user_id]);
    }
    
    return true;
}
```

## 4. 会员码系统

### 4.1 会员码生成

```php
/**
 * 生成会员码
 * @param string $membership_type 会员类型
 * @param int $count 生成数量
 * @param string $batch_id 批次ID
 * @return array 生成的会员码列表
 */
function generateMembershipCodes($membership_type, $count = 1, $batch_id = null) {
    if (!$batch_id) {
        $batch_id = date('Ymd') . '_' . uniqid();
    }
    
    $codes = [];
    for ($i = 0; $i < $count; $i++) {
        $code = generateUniqueCode();
        $expires_at = date('Y-m-d H:i:s', strtotime('+1 year')); // 会员码1年有效期
        
        $sql = "INSERT INTO membership_codes 
                (code, membership_type, expires_at, batch_id) 
                VALUES (?, ?, ?, ?)";
        
        executeQuery($sql, [$code, $membership_type, $expires_at, $batch_id]);
        $codes[] = $code;
    }
    
    return $codes;
}

/**
 * 生成唯一会员码
 * @return string 8位会员码
 */
function generateUniqueCode() {
    do {
        $code = strtoupper(substr(md5(uniqid(mt_rand(), true)), 0, 8));
        $exists = executeQuery("SELECT id FROM membership_codes WHERE code = ?", [$code]);
    } while ($exists);
    
    return $code;
}
```

### 4.2 会员码验证和使用

```php
/**
 * 验证并使用会员码
 * @param string $code 会员码
 * @param int $user_id 用户ID
 * @return array 验证结果
 */
function redeemMembershipCode($code, $user_id) {
    // 验证会员码
    $sql = "SELECT * FROM membership_codes WHERE code = ? AND status = 'active'";
    $membership_code = executeQuery($sql, [$code]);
    
    if (!$membership_code) {
        return ['success' => false, 'message' => '会员码不存在或已使用'];
    }
    
    // 检查是否过期
    if ($membership_code['expires_at'] && strtotime($membership_code['expires_at']) < time()) {
        return ['success' => false, 'message' => '会员码已过期'];
    }
    
    // 获取用户当前信息
    $user = executeQuery("SELECT * FROM users WHERE id = ?", [$user_id]);
    if (!$user) {
        return ['success' => false, 'message' => '用户不存在'];
    }
    
    // 开始事务
    beginTransaction();
    
    try {
        // 更新会员码状态
        $update_code_sql = "UPDATE membership_codes 
                           SET status = 'used', used_by_user_id = ?, used_at = NOW() 
                           WHERE id = ?";
        executeQuery($update_code_sql, [$user_id, $membership_code['id']]);
        
        // 更新用户会员信息
        if ($membership_code['membership_type'] === 'monthly') {
            $expires_at = date('Y-m-d H:i:s', strtotime('+30 days'));
            $quota_reset = date('Y-m-d H:i:s', strtotime('+30 days'));
            
            $update_user_sql = "UPDATE users 
                               SET membership_type = 'monthly', 
                                   membership_expires_at = ?, 
                                   download_quota = 10, 
                                   quota_reset_date = ? 
                               WHERE id = ?";
            executeQuery($update_user_sql, [$expires_at, $quota_reset, $user_id]);
        } else if ($membership_code['membership_type'] === 'permanent') {
            $update_user_sql = "UPDATE users 
                               SET membership_type = 'permanent', 
                                   membership_expires_at = NULL, 
                                   download_quota = -1, 
                                   quota_reset_date = NULL 
                               WHERE id = ?";
            executeQuery($update_user_sql, [$user_id]);
        }
        
        commitTransaction();
        
        return [
            'success' => true, 
            'message' => '会员升级成功', 
            'membership_type' => $membership_code['membership_type']
        ];
        
    } catch (Exception $e) {
        rollbackTransaction();
        return ['success' => false, 'message' => '升级失败：' . $e->getMessage()];
    }
}
```

## 5. 前端实现

### 5.1 Dashboard会员升级模态框

```html
<!-- 会员升级模态框 -->
<div id="membershipModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-2">会员升级</h3>
                <p class="text-gray-600">请输入会员码完成升级</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">会员码</label>
                <input type="text" id="membershipCode" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="请输入8位会员码" maxlength="8">
            </div>
            
            <div class="flex gap-3">
                <button id="upgradeBtn" 
                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-6 rounded-lg transition-colors">
                    升级
                </button>
                <button id="getCodeBtn" 
                        class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-6 rounded-lg transition-colors">
                    获取会员码
                </button>
            </div>
            
            <button id="closeMembershipModal" 
                    class="w-full mt-4 text-gray-500 hover:text-gray-700 py-2">
                取消
            </button>
        </div>
    </div>
</div>
```

### 5.2 前端JavaScript逻辑

```javascript
// 会员升级相关功能
class MembershipManager {
    constructor() {
        this.modal = document.getElementById('membershipModal');
        this.codeInput = document.getElementById('membershipCode');
        this.upgradeBtn = document.getElementById('upgradeBtn');
        this.getCodeBtn = document.getElementById('getCodeBtn');
        this.closeBtn = document.getElementById('closeMembershipModal');
        
        this.initEventListeners();
    }
    
    initEventListeners() {
        // 升级按钮点击
        this.upgradeBtn.addEventListener('click', () => this.handleUpgrade());
        
        // 获取会员码按钮点击
        this.getCodeBtn.addEventListener('click', () => this.handleGetCode());
        
        // 关闭模态框
        this.closeBtn.addEventListener('click', () => this.closeModal());
        
        // 点击背景关闭
        this.modal.addEventListener('click', (e) => {
            if (e.target === this.modal) this.closeModal();
        });
        
        // 回车键提交
        this.codeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.handleUpgrade();
        });
    }
    
    showModal(membershipType) {
        this.membershipType = membershipType;
        this.modal.classList.remove('hidden');
        this.codeInput.focus();
    }
    
    closeModal() {
        this.modal.classList.add('hidden');
        this.codeInput.value = '';
    }
    
    async handleUpgrade() {
        const code = this.codeInput.value.trim().toUpperCase();
        
        if (!code) {
            alert('请输入会员码');
            return;
        }
        
        if (code.length !== 8) {
            alert('会员码必须是8位');
            return;
        }
        
        try {
            this.upgradeBtn.disabled = true;
            this.upgradeBtn.textContent = '升级中...';
            
            const response = await fetch('/api/redeem_membership_code.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code: code })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('升级成功！');
                this.closeModal();
                location.reload(); // 刷新页面显示新的会员状态
            } else {
                alert('升级失败：' + result.message);
            }
        } catch (error) {
            alert('网络错误，请稍后重试');
        } finally {
            this.upgradeBtn.disabled = false;
            this.upgradeBtn.textContent = '升级';
        }
    }
    
    handleGetCode() {
        // 显示提示信息
        alert('前往小红书商店下一单可获取会员码');
        
        // 跳转到小红书商品页面
        window.open('https://www.xiaohongshu.com/goods/your-product-link', '_blank');
    }
}

// 下载权限检查
class DownloadManager {
    static async checkPermission(downloadType) {
        try {
            const response = await fetch('/api/check_download_permission.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ download_type: downloadType })
            });
            
            const result = await response.json();
            return result;
        } catch (error) {
            return { allowed: false, reason: '网络错误' };
        }
    }
    
    static async handleDownload(downloadType, downloadFunction) {
        const permission = await this.checkPermission(downloadType);
        
        if (!permission.allowed) {
            if (permission.reason === '需要会员权限') {
                alert('此功能需要会员权限，请先升级会员');
                // 可以在这里触发会员升级模态框
            } else {
                alert('下载失败：' + permission.reason);
            }
            return;
        }
        
        // 执行下载
        try {
            await downloadFunction();
            
            // 记录下载
            await fetch('/api/record_download.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ download_type: downloadType })
            });
        } catch (error) {
            alert('下载失败，请稍后重试');
        }
    }
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    const membershipManager = new MembershipManager();
    
    // 绑定会员升级按钮
    document.querySelectorAll('.upgrade-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const membershipType = e.target.dataset.membershipType;
            membershipManager.showModal(membershipType);
        });
    });
    
    // 绑定受限制的下载按钮
    document.getElementById('downloadHDAllButton')?.addEventListener('click', () => {
        DownloadManager.handleDownload('hd_combo', () => {
            // 原有的下载逻辑
            downloadHDAll();
        });
    });
    
    document.getElementById('downloadAvatarButton')?.addEventListener('click', () => {
        DownloadManager.handleDownload('avatar', () => {
            // 原有的头像下载逻辑
            downloadAvatar();
        });
    });
});
```

## 6. 后端API设计

### 6.1 会员码兑换API

```php
<?php
// /api/redeem_membership_code.php
require_once 'config.php';
require_once 'auth.php';

header('Content-Type: application/json');

// 检查用户登录
$user = getCurrentUser();
if (!$user) {
    http_response_code(401);
    echo json_encode(['success' => false, 'message' => '请先登录']);
    exit;
}

// 获取POST数据
$input = json_decode(file_get_contents('php://input'), true);
$code = strtoupper(trim($input['code'] ?? ''));

if (empty($code)) {
    echo json_encode(['success' => false, 'message' => '会员码不能为空']);
    exit;
}

if (strlen($code) !== 8) {
    echo json_encode(['success' => false, 'message' => '会员码格式错误']);
    exit;
}

// 调用会员码兑换函数
$result = redeemMembershipCode($code, $user['id']);
echo json_encode($result);
?>
```

### 6.2 下载权限检查API

```php
<?php
// /api/check_download_permission.php
require_once 'config.php';
require_once 'auth.php';

header('Content-Type: application/json');

// 检查用户登录
$user = getCurrentUser();
if (!$user) {
    echo json_encode(['allowed' => false, 'reason' => '请先登录']);
    exit;
}

// 获取POST数据
$input = json_decode(file_get_contents('php://input'), true);
$download_type = $input['download_type'] ?? '';

if (empty($download_type)) {
    echo json_encode(['allowed' => false, 'reason' => '下载类型不能为空']);
    exit;
}

// 检查下载权限
$result = checkDownloadPermission($user['id'], $download_type);
echo json_encode($result);
?>
```

### 6.3 下载记录API

```php
<?php
// /api/record_download.php
require_once 'config.php';
require_once 'auth.php';

header('Content-Type: application/json');

// 检查用户登录
$user = getCurrentUser();
if (!$user) {
    echo json_encode(['success' => false, 'message' => '请先登录']);
    exit;
}

// 获取POST数据
$input = json_decode(file_get_contents('php://input'), true);
$download_type = $input['download_type'] ?? '';
$wallpaper_id = $input['wallpaper_id'] ?? null;

if (empty($download_type)) {
    echo json_encode(['success' => false, 'message' => '下载类型不能为空']);
    exit;
}

// 消耗下载配额
$success = consumeDownloadQuota($user['id'], $download_type, $wallpaper_id);

echo json_encode([
    'success' => $success,
    'message' => $success ? '下载记录成功' : '下载记录失败'
]);
?>
```

## 7. 定时任务

### 7.1 会员过期处理（每日执行）

```php
<?php
// /scripts/handle_expired_memberships.php
require_once '../config.php';

// 处理过期会员
handleExpiredMemberships();

// 记录日志
file_put_contents('../logs/membership_cleanup.log', 
    date('Y-m-d H:i:s') . " - 会员过期处理完成\n", 
    FILE_APPEND | LOCK_EX
);

echo "会员过期处理完成\n";
?>
```

### 7.2 Windows定时任务设置

```batch
@echo off
REM 每日凌晨2点执行会员过期处理
cd /d F:\XAMPP\htdocs
php vip/api/handle_expired_memberships.php
```

## 8. 部署清单

### 8.1 数据库变更
1. 执行users表扩展SQL
2. 创建membership_codes表
3. 创建user_download_logs表
4. 添加必要的索引

### 8.2 文件创建
1. `vip/api/redeem_membership_code.php` - 会员码兑换API
2. `vip/api/check_download_permission.php` - 下载权限检查API
3. `vip/api/record_download.php` - 下载记录API
4. `vip/api/handle_expired_memberships.php` - 定时任务脚本
5. 更新 `dashboard.html` - 添加会员升级模态框
6. 更新 `yulan.html` - 添加下载权限检查

### 8.3 配置项
1. 小红书商品链接配置
2. 会员码生成规则配置
3. 定时任务配置

## 9. 测试用例

### 9.1 会员码测试
- 生成会员码
- 验证有效会员码
- 验证无效会员码
- 验证过期会员码
- 验证已使用会员码

### 9.2 下载权限测试
- 免费用户下载受限功能
- 1元会员下载受限功能
- 永久会员下载受限功能
- 配额耗尽后的下载
- 会员过期后的下载

### 9.3 配额重置测试
- 30天周期配额重置
- 会员到期前的配额重置
- 跨月份的配额重置

## 10. 监控和统计

### 10.1 关键指标
- 会员转化率
- 下载配额使用情况
- 会员码使用统计
- 用户下载行为分析

### 10.2 报表查询

```sql
-- 会员统计
SELECT 
    membership_type,
    COUNT(*) as user_count,
    COUNT(CASE WHEN membership_expires_at > NOW() THEN 1 END) as active_count
FROM users 
GROUP BY membership_type;

-- 下载统计
SELECT 
    download_type,
    COUNT(*) as download_count,
    COUNT(DISTINCT user_id) as unique_users
FROM user_download_logs 
WHERE download_date >= CURDATE() - INTERVAL 30 DAY
GROUP BY download_type;

-- 会员码使用统计
SELECT 
    membership_type,
    status,
    COUNT(*) as code_count
FROM membership_codes 
GROUP BY membership_type, status;
```

---

**本方案提供了完整的会员系统实现指南，包括数据库设计、业务逻辑、前后端代码和部署方案。可直接用于开发实施。**