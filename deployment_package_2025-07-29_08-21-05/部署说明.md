# 线上环境修复部署包

## 问题描述
线上环境 `https://www.jelisgo.cn/` 出现以下问题：
1. `/api/vip/membership_status.php` 返回500错误
2. 数据库连接失败：`Access denied for user 'root'@'localhost' (using password: NO)`
3. 前端图片加载失败，会员状态显示异常

## 修复内容

### 1. 数据库配置修复 (config.php)
- 添加环境自动检测功能
- 分离本地和线上数据库配置
- 增加数据库连接测试功能
- PHP 8.2 兼容性优化

### 2. 会员状态API修复 (membership_status.php)
- PHP 8.2 兼容性修复
- 增强错误处理和日志记录
- 优化CORS配置适配Nginx
- 移除对不存在表的检查
- 添加调试信息输出

## 部署步骤

### 第一步：获取数据库配置信息
联系服务器管理员或查看控制面板，获取以下信息：
- 数据库主机地址（通常是 localhost）
- 数据库名称（可能包含前缀，如：jelisgo_wallpaper_db）
- 数据库用户名（通常不是 root）
- 数据库密码

### 第二步：更新配置文件
编辑 `config.php` 文件，找到以下部分并更新：

```php
if (isOnlineEnvironment()) {
    // 线上环境配置 - 请替换为实际值
    define("DB_HOST", "localhost");                    // 数据库主机
    define("DB_NAME", "jelisgo_wallpaper_db");         // 实际数据库名
    define("DB_USER", "jelisgo_wallpaper");            // 实际用户名
    define("DB_PWD", "your_actual_password");          // 实际密码
}
```

### 第三步：上传文件
1. 将 `config.php` 上传到网站根目录，覆盖原文件
2. 将 `membership_status.php` 上传到 `/api/vip/` 目录，覆盖原文件

### 第四步：创建日志目录
在网站根目录创建 `logs` 目录（如果不存在）：
```bash
mkdir -p /www/wwwroot/jelisgo.cn/logs
chmod 755 /www/wwwroot/jelisgo.cn/logs
```

### 第五步：设置文件权限
```bash
chmod 644 /www/wwwroot/jelisgo.cn/config.php
chmod 644 /www/wwwroot/jelisgo.cn/api/vip/membership_status.php
```

### 第六步：测试配置
访问以下URL测试数据库连接：
```
https://www.jelisgo.cn/config.php
```

应该返回类似以下的JSON响应：
```json
{
    "success": true,
    "environment": "online",
    "config": {
        "host": "localhost",
        "database": "jelisgo_wallpaper_db",
        "user": "jelisgo_wallpaper",
        "charset": "utf8mb4"
    },
    "timestamp": "2025-07-29 14:20:00"
}
```

### 第七步：测试API
访问以下URL测试会员状态API：
```
https://www.jelisgo.cn/api/vip/membership_status.php?user_id=1
```

应该返回会员状态信息或401未登录错误（这是正常的）。

### 第八步：重启服务（如需要）
如果使用PHP-FPM，可能需要重启：
```bash
sudo systemctl restart php-fpm
sudo systemctl restart nginx
```

## 验证修复效果

### 1. 检查API响应
- 访问 `https://www.jelisgo.cn/api/vip/membership_status.php`
- 应该返回401错误而不是500错误
- 错误信息应该是 "用户未登录" 而不是数据库连接错误

### 2. 检查前端功能
- 打开 `https://www.jelisgo.cn/`
- 登录用户账号
- 检查会员状态是否正常显示
- 检查图片是否能正常加载

### 3. 检查浏览器控制台
- 不应该再有500错误
- 会员状态API应该正常返回数据

## 常见问题排除

### 问题1：仍然出现数据库连接错误
**解决方案：**
1. 检查数据库配置信息是否正确
2. 确认数据库用户权限
3. 检查数据库服务是否运行
4. 查看服务器错误日志

### 问题2：API返回404错误
**解决方案：**
1. 确认文件上传路径正确
2. 检查文件权限设置
3. 确认Nginx配置正确

### 问题3：前端仍然显示错误
**解决方案：**
1. 清除浏览器缓存
2. 检查前端JavaScript是否有缓存
3. 确认用户登录状态

## 技术支持

如果遇到问题，请提供以下信息：
1. 错误日志内容（/logs/目录下的文件）
2. 浏览器控制台错误信息
3. 服务器错误日志
4. 当前数据库配置信息（不包含密码）

## 备注

- 本修复包已在本地环境测试通过
- 兼容 Nginx 1.26 + PHP 8.2 环境
- 包含完整的错误处理和日志记录
- 支持环境自动检测，无需手动切换配置
