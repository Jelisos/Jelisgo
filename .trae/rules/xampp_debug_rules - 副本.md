## 四、自动化测试脚本生成规范

**设计理念**：
- 零人工干预，自动绕过认证
- 自愈式修复，渐进式验证

**脚本结构**：
- 核心功能测试、边界条件测试、集成测试
- 环境初始化、前置检查、结果输出、清理恢复

**修复策略**：
- 数据库连接、API接口、前端JS、权限验证、数据一致性
- 紧急修复、标准修复、优化修复

**设计原则**：
- 原子性操作、幂等性保证、自包含设计
- 标准化输出、性能优化、安全隔离

**全流程诊断测试规范**（基于月度会员下载次数显示问题测试经验）：

**测试脚本设计要点**：
1. **分步骤验证**：将复杂问题拆解为独立的验证步骤，每步都有明确的成功/失败标准
2. **数据流追踪**：从数据库 → 后端函数 → API响应 → 前端显示的完整链路测试
3. **关键节点检查**：重点验证数据传递的关键节点，如函数返回值、API响应结构
4. **用户凭据集成**：使用真实用户账号进行端到端测试，确保权限和数据的真实性
5. **可视化输出**：生成HTML格式的诊断报告，便于问题定位和结果展示

**标准测试流程**：
```
步骤1：环境检查（数据库连接、服务状态）
步骤2：用户验证（登录状态、权限检查）
步骤3：核心函数测试（关键业务逻辑函数）
步骤4：API响应构建（模拟完整API调用）
步骤5：数据源验证（相关数据表检查）
步骤6：前端逻辑模拟（JavaScript执行模拟）
步骤7：问题总结（数据对比、问题定位、解决建议）
```

**问题定位策略**：
- **精确定位**：通过对比各步骤的预期值与实际值，精确定位问题所在环节
- **数据追踪**：记录数据在各个环节的变化，识别数据丢失或转换错误的位置
- **根因分析**：不仅找出问题现象，更要分析问题的根本原因（如函数逻辑错误、数据结构不匹配等）

**测试脚本命名规范**：
- 综合诊断：`[模块名]_display_test.php`
- 功能验证：`[功能名]_function_test.php`
- 数据检查：`[数据源]_data_test.php`


## 六、Session登录问题调试规范

**基于实际案例总结的系统性调试思路**

### 6.1 问题分析的三层架构思维

**第一层：前后端交互层**
- 检查前端请求格式（JSON vs URL参数）
- 验证后端参数获取方式（$_POST vs json_decode）
- 确认Content-Type头设置正确性
- 验证API响应格式与前端期望一致性

**第二层：Session机制层**
- 检查Session ID生成与传递
- 验证session_regenerate_id()机制
- 确认Session数据写入数据库流程
- 检查Cookie设置与传递

**第三层：数据持久化层**
- 验证数据库Session表结构
- 检查Session写入SQL语句逻辑
- 确认时间戳字段设置（created_at/updated_at）
- 验证Session数据序列化/反序列化

### 6.2 调试工具链使用规范

**诊断脚本创建顺序**：
1. **Session状态诊断脚本**：检查当前Session ID、PHP Session数据、数据库记录
2. **Session重新生成测试脚本**：验证session_regenerate_id()前后的数据变化
3. **真实登录流程测试脚本**：模拟完整的用户登录过程
4. **前端集成测试页面**：验证浏览器环境下的Session传递

**日志分析重点**：
- Apache错误日志中的Session写入调试信息
- PHP Session数据的序列化格式
- 数据库中Session记录的user_id字段状态
- Session ID变化轨迹追踪

### 6.3 常见问题模式与解决方案

**模式1：前后端参数不匹配**
- 现象：API调用成功但参数获取失败
- 解决：统一支持多种参数获取方式（URL参数 + JSON数据）
- 代码模式：`$action = $_GET['action'] ?? json_decode(file_get_contents('php://input'), true)['action'] ?? null;`

**模式2：Session regenerate机制缺陷**
- 现象：登录成功但Session数据丢失
- 解决：确保session_regenerate_id()后正确写入数据库
- 关键点：新Session ID的数据库记录创建

**模式3：数据库写入逻辑错误**
- 现象：Session数据存在但时间戳异常
- 解决：将REPLACE INTO改为先检查后INSERT/UPDATE
- 关键点：正确设置created_at和updated_at字段

### 6.4 调试效率提升规则

**"三步定位法"**：
1. **快速验证**：使用现有诊断脚本快速确认问题范围
2. **精确定位**：创建针对性测试脚本定位具体环节
3. **根因修复**：基于定位结果进行代码修复

**"数据流追踪法"**：
- 从用户操作 → 前端请求 → 后端处理 → 数据库存储的完整链路
- 在每个关键节点设置调试输出
- 对比预期值与实际值，精确定位问题点

**"渐进式修复法"**：
- 优先修复影响面最大的核心问题
- 保持向后兼容性，避免引入新问题
- 每次修复后立即验证，确保问题真正解决

### 6.5 预防性措施

**代码健壮性**：
- API接口支持多种参数格式
- Session写入包含完整的错误处理
- 数据库操作使用事务保证一致性

**调试友好性**：
- 关键流程添加详细日志输出
- Session操作包含调试信息
- 错误信息包含足够的上下文

**测试覆盖性**：
- 保留核心诊断脚本用于回归测试
- 建立Session问题的标准测试流程
- 定期验证Session机制的正常运行